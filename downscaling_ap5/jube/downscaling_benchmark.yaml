name:    ap5-all
outpath: ap5_run
comment: MAELSTROM AP5 benchmark jube script

parameterset:
  - name: appParameter
    parameter:
      - name: conf_md
        tag: "!test"
        type: string
        _: "$jube_benchmark_home/../config/config_wgan.json"
      - name: conf_md
        tag: "test"
        type: string
        _: "$jube_benchmark_home/../config/config_wgan_test.json"
      - name: conf_ds
        type: string
        _: "$jube_benchmark_home/../config/config_ds_tier2.json"
      - name: exp_name
        type: string
        _: "wgan_benchmark_jube_$jube_benchmark_id"
      - name: model
        type: string
        _: "wgan"
      - name: dataset
        type: string
        _: "tier2"
      - name: indir
        type: string
        tag: "(jwb|jwc|hdfml)+cscratch"
        _: "${SCRATCH}/maelstrom/maelstrom_data/ap5_michael/preprocessed_tier2/monthly_files_copy/"
      - name: indir
        type: string
        tag: "(jwb|jwc|hdfml)+cscratch"
        _: "${CSCRATCH}/maelstrom/maelstrom_data/ap5_michael/preprocessed_tier2/monthly_files_copy/"
      - name: js_norm
        type: string
        tag: jwb|jwc|hdfml
        _: "/p/scratch/deepacf/maelstrom/maelstrom_data/ap5_michael/preprocessed_tier2/monthly_files_copy/zscore_norm.json"
      - name: outdir
        type: string
        _: "$jube_benchmark_home/../trained_models"
      - name: file_pattern
        tag: "data_loader"
        type: string
        _: "downscaling_tier2_train*"
      - name: nfiles_load
        tag: "data_loader"
        type: int
        _: 33
      - name: nepochs
        tag: "data_loader"
        type: int
        _: 10
      - name: var_tar2in
        tag: "data_loader"
        type: string
        _: "hsurf_tar"

  - name: globalParameter
    parameter:
      - name: modules
        tag: "jwb|jwc|hdfml"
        separator: "|"
        _: 
          source $jube_benchmark_home/../env_setup/modules_jsc.sh &&
          export SRUN_CPUS_PER_TASK=${SLURM_CPUS_PER_TASK}
      - {name: modules, tag: "e4", _: source $jube_benchmark_home/../env_setup/modules_e4.sh}
      - name: systemname
        tag: jwc
        _: jwc
      - name: systemname
        tag: jwb
        _: jwb
      - name: systemname
        tag: hdfml
        _: hdfml
      - name: systemname
        tag: e4
        _: e4

  - name: executeset
    init_with: platform.xml
  - name: systemParameter
    init_with: platform.xml
    parameter:
      - name: preprocess
        mode: text
        separator: |
        _:
          $modules;
      - name: threadspertask
        _: 40
      - name: nodes
        _: 1
      - name: n_gpu
        _: 1
      - name: taskspernode
        _: $n_gpu
      - name: timelimit
        tag: test
        _: "02:00:00"
      - name: timelimit
        tag: "!test"
        _: "20:00:00"
      - name: account
        _: deepacf
      - name: queue
        tag: "jwb+!test"
        _: booster
      - name: queue
        tag: "jwb+test"
        _: develbooster
      - name: queue
        tag: "jwc+!test"
        _: gpus
      - name: queue
        tag: "jwc+test"
        _: develgpus
      - name: queue
        tag: hdfml
        _: batch
      - name: gres
        _: gpu:$n_gpu
      - name: executable
        tag: "!data_loader"
        _: python -u $jube_benchmark_home/../main_scripts/main_train.py
      - name: executable
        tag: data_loader
        _: python -u $jube_benchmark_home/../tests/demo_tfdataset_ap5.py
      - name: args_exec
        tag: "!data_loader"
        mode: text
        _: > 
          -in ${indir}
          -out ${outdir}
          -model ${model}
          -dataset ${dataset}
          -exp_name ${exp_name}
          -conf_md ${conf_md}
          -conf_ds ${conf_ds}
          -js_norm ${js_norm}
          -id $${SLURM_JOBID}
      - name: args_exec
        tag: "data_loader"
        mode: text
        _: > 
          -d ${indir}
          -f ${file_pattern}
          -n ${nfiles_load}
          -ne ${nepochs}
          -js_norm ${js_norm}
          -tar2in ${var_tar2in}

patternset:
   - name: perf_patterns
     pattern:
      - {name: epoch, type: int, _: "Epoch\\s+$jube_pat_int/\\s*$jube_pat_nint"}
      - {name: epoch_time, type: int, _: "-\\s+${jube_pat_int}s\\s+-"}
      - {name: recon_loss_train, type: float, _: "- recon_loss:\\s+$jube_pat_fp"}
      - {name: recon_loss_val, type: float, _: "val_recon_loss:\\s+$jube_pat_fp"}
      - {name: c_loss, type: float, _: "c_loss:\\s+$jube_pat_fp"}
      - {name: g_loss, type: float, _: "cg_loss:\\s+$jube_pat_fp"}
      - {name: data_loading, type: float, _: "reading time:\\s+$jube_pat_fp"}
      - {name: jobid, type: int, _: "Submitted batch job $jube_pat_int" }

analyser:
    name: analyse
    reduce: false
    use: perf_patterns
    analyse:
        step: submit
        file:
          - job.out
          - stdout

result:
    use: analyse
    table:
      name: result
      style: pretty
      sort: iter_pat
      column:
        - {title: "JobID", _: jobid}
        - {title: "Job_Time", _: timelimit}
        - {title: "model configuration", _: conf_md}
        - {title: "dataset configuration", _: conf_ds}
        - {title: "# nodes", _: nodes}
        - {title: "# gpu", _: n_gpu}
        - {title: "last recon. loss train", _: recon_loss_train_last}
        - {title: "last recon. loss val", _: recon_loss_val_last}
        - {title: "last generator loss ", _: g_loss_last}
        - {title: "last critic loss ", _: c_loss_last}
        - {title: "last epoch ", _: epoch_last}
        - {title: "first epoch time [s]", _: epoch_time_first}
        - {title: "last epoch time [s]", _: epoch_time_last}
        - {title: "avg. epoch time [s]", _: epoch_time_avg}
        - {title: "avg. ds load time [s]", _: data_loading_avg}
        - {title: "min. ds load time [s]", _: data_loading_min}
        - {title: "max. ds load time [s]", _: data_loading_max}

step:
  - name:   setup_venv
    use:
      - globalParameter
      - systemParameter
    do:
      _:
        unset PYTHONPATH;
        $modules;
        cd $jube_benchmark_home/../env_setup/ &&
        source ./setup_env_jube.sh venv_$systemname
  - name:   submit
    use:
      - appParameter
      - globalParameter
      - systemParameter
      - executeset
      - from: platform.xml
        _: jobfiles
      - from: platform.xml
        _: executesub
    do:
      done_file: $ready_file
      error_file: $error_file
      _:
        $modules;
        source $jube_benchmark_home/../virtual_envs/venv_$systemname/bin/activate;
        $submit $submit_script

